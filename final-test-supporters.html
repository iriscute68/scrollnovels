<!DOCTYPE html>
<html>
<head>
    <title>FINAL TEST - Top Supporters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 28px; }
        .content { padding: 30px; }
        .tabs { display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; color: #666; transition: all 0.3s; }
        .tab-btn:hover { color: #667eea; }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { margin: 20px 0; }
        .supporters-display { min-height: 150px; padding: 20px; background: #f9f9f9; border-radius: 4px; }
        .supporter-card { background: linear-gradient(to right, #fef3c7, #fed7aa); padding: 15px; border-radius: 4px; margin: 10px 0; display: flex; align-items: center; gap: 15px; }
        .supporter-avatar { width: 40px; height: 40px; border-radius: 50%; background: #fcd34d; flex-shrink: 0; }
        .supporter-info { flex: 1; }
        .supporter-info h3 { margin: 0; color: #1f2937; }
        .supporter-info p { margin: 2px 0; font-size: 0.9em; color: #666; }
        .supporter-points { font-weight: bold; color: #b45309; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 4px; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-entry { margin: 3px 0; }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-info { color: #2196F3; }
        button { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #5568d3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Top Supporters - Final Test</h1>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('test')">üß™ Test</button>
                <button class="tab-btn" onclick="switchTab('demo')">üìñ Demo</button>
                <button class="tab-btn" onclick="switchTab('status')">üìä Status</button>
            </div>
            
            <!-- Test Tab -->
            <div id="test-content" class="tab-content active">
                <div class="section">
                    <h2>Manual Fetch Test</h2>
                    <button onclick="testFetch()">Test API Call</button>
                </div>
                
                <div class="section">
                    <h3>API Response:</h3>
                    <div class="log" id="test-log"></div>
                </div>
            </div>
            
            <!-- Demo Tab -->
            <div id="demo-content" class="tab-content">
                <div class="section">
                    <h2>Live Demo - Book 4 (Author ID 1)</h2>
                    <button onclick="demoLoadSupporters()">Click to Load Supporters</button>
                </div>
                
                <div class="section">
                    <h3>Supporters Display:</h3>
                    <div id="demo-display" class="supporters-display">
                        <div style="text-align: center; color: #999; padding: 40px;">Click button above to load supporters</div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Debug Log:</h3>
                    <div class="log" id="demo-log"></div>
                </div>
            </div>
            
            <!-- Status Tab -->
            <div id="status-content" class="tab-content">
                <div class="section">
                    <h2>Feature Status</h2>
                    <p>‚úì API Working: Tested and verified</p>
                    <p>‚úì HTML Elements: All present</p>
                    <p>‚úì JavaScript Function: Available</p>
                    <p>‚úì Cache Headers: Added</p>
                </div>
                
                <div class="section">
                    <h2>Possible Issues</h2>
                    <ul style="margin-left: 20px;">
                        <li>Browser cache - Hard refresh with Ctrl+Shift+R</li>
                        <li>JavaScript disabled - Check browser settings</li>
                        <li>Network issue - Check network tab in DevTools</li>
                        <li>Wrong book ID - Some books have 0 supporters (correct)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + '-content').classList.add('active');
            event.target.classList.add('active');
        }
        
        function addLog(log, msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.textContent = '> ' + msg;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }
        
        async function testFetch() {
            const log = document.getElementById('test-log');
            log.innerHTML = '';
            
            addLog(log, 'Starting test...', 'info');
            
            const url = 'http://localhost/scrollnovels/api/supporters/get-top-supporters.php?author_id=1&limit=200';
            addLog(log, 'URL: ' + url, 'info');
            
            try {
                const response = await fetch(url);
                addLog(log, 'Response status: ' + response.status, response.ok ? 'success' : 'error');
                
                const text = await response.text();
                addLog(log, 'Response length: ' + text.length + ' bytes', 'success');
                
                const data = JSON.parse(text);
                addLog(log, 'JSON valid, success=' + data.success, 'success');
                addLog(log, 'Total supporters: ' + data.total, 'success');
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(sup => {
                        addLog(log, '‚Ä¢ ' + sup.username + ': ' + sup.points_total + ' pts', 'success');
                    });
                } else {
                    addLog(log, 'No supporters found', 'info');
                }
            } catch (e) {
                addLog(log, 'ERROR: ' + e.message, 'error');
            }
        }
        
        function htmlEscape(text) {
            return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        async function demoLoadSupporters() {
            const log = document.getElementById('demo-log');
            const display = document.getElementById('demo-display');
            log.innerHTML = '';
            display.innerHTML = '<div style="text-align: center; color: #999;">Loading...</div>';
            
            addLog(log, 'Loading supporters for author 1...', 'info');
            
            const url = 'http://localhost/scrollnovels/api/supporters/get-top-supporters.php?author_id=1&limit=200';
            
            try {
                const response = await fetch(url);
                addLog(log, 'Fetch successful, status: ' + response.status, 'success');
                
                const data = await response.json();
                addLog(log, 'JSON parsed, success=' + data.success, 'success');
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '';
                    data.data.forEach((sup, i) => {
                        html += `
                            <div class="supporter-card">
                                <div class="supporter-avatar"></div>
                                <div class="supporter-info">
                                    <h3>#${i+1} ${htmlEscape(sup.username)}</h3>
                                    <p><span class="supporter-points">‚≠ê ${sup.points_total} pts</span> ‚Ä¢ ${sup.status}</p>
                                </div>
                            </div>
                        `;
                    });
                    display.innerHTML = html;
                    addLog(log, 'Displayed ' + data.data.length + ' supporter(s)', 'success');
                } else {
                    display.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No supporters yet</div>';
                    addLog(log, 'No supporters found', 'info');
                }
            } catch (e) {
                display.innerHTML = '<div style="color: #f44336; padding: 20px;">Error: ' + htmlEscape(e.message) + '</div>';
                addLog(log, 'ERROR: ' + e.message, 'error');
            }
        }
        
        // Auto-run test on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('test-log').innerHTML = '';
                addLog(document.getElementById('test-log'), 'Ready. Click "Test API Call" button to start.', 'info');
            }, 500);
        });
    </script>
</body>
</html>
